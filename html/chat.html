<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- The core Firebase JS SDK is always required and must be listed first -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<!-- Add Firebase products that you want to use -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>


<style>
body {
    font-family: Arial;
    background: #F1F1F1;
}

.chat-container {
    position: fixed;
    right: 0;
    bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 10px;
    padding: 15px;
    width: 400px;
    height: auto;
}

.chat-container.open .chat-box {
    transform: translateY(70px);
    opacity: 1;
}
.chat-container.close .chat-box {
    opacity: 0;
}
.chat-container.open .chat-floaty {
    transform: translateY(90px);
}

.chat-box {
    background: #FFF;
    width: 100%;
    height: 550px;
    max-height: 80vh;
    border-radius: 15px;
    box-shadow: 0 0 10px rgba(0,0,0,.2);
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    overflow: hidden;
    transform: translateY(150%);
    transition: all 1s ease;
    animation-name: chat-box;
    animation-duration: 1s;
    animation-iteration-count: 1;
    transform-origin: bottom right;
}
@keyframes chat-box {
    from {
        opacity: 0;
        transform: translateY(500px);
    }
    to {
        opacity: 1;
    }
}
.conversation {
    display: flex;
    flex-direction: column;
    gap: 20px;
    flex-grow: 1;
    overflow-y: scroll;
    overflow-x: hidden;
    padding: 10px 20px;
    border-radius: 15px 15px 0 0;
}

/** Message Bubbles **/
.message {
    background: #DDD;
    color: #111;
    border-radius: 10px;
    padding: 10px 15px;
    max-width: 60%;
    position: relative;
    align-self: flex-end;
    line-height: 1.56em;
    animation-name: message;
    animation-duration: 1.2s;
    font-size: 13px;
    word-break: break-word;
}
@keyframes message {
    from {
        opacity: 0;
        translate: 0 50px;
        position: static;
    }
    to {
        opacity: 1;
        translate: 0 0;
    }
}
.message:first-of-type {
    margin-top: 10px;
}
.message:after {
    content: '';
    position: absolute;
    bottom: -12px;
    right: 0px;
    border-top: 5px solid #DDD;
    border-bottom: 15px solid transparent;
    border-right: 20px solid #DDD;
    border-left: 15px solid transparent;
}
.message.bot {
    background: #0a2764;
    color: #FFF;
    align-self: flex-start;
}
.message.bot:after {
    right: unset;
    left: 0px;
    border-top: 5px solid #0a2764;
    border-right: 10px solid transparent;
    border-left: 20px solid #0a2764;
}
.message.bot.typing span {
    display: inline-block;
    width: 8px;
    height: 8px;
    background: #fff;
    border-radius: 10px;
    margin: 0 3px;
    opacity: 0.75;
    animation-name: typing-dots;
    animation-delay: 0s;
    animation-duration: 1000ms;
    animation-iteration-count: infinite;
    animation-timing-function: ease;
}
.message.bot.typing span:nth-of-type(2) {
    animation-delay: 400ms;
}
.message.bot.typing span:nth-of-type(3) {
    animation-delay: 700ms;
}
@keyframes typing-dots {
    0% {
        transform: scale(1);
    }
    33% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.4);
    }
    100% {
        transform: scale(1);
    }
}

/** User Inputs **/
.message-prompt {
    padding: 0 20px 20px 20px;
    display: flex;
    align-self: stretch;
    gap: 0px;
    font-size: 14px;
}
.message-prompt input {
    /*border-radius: 15px;*/
    border-radius: 15px 0 0 15px;
    padding: 12px;
    width: 100%;
    border: 1px solid #EEE;
    background: #EEE;
}
.message-prompt input:focus {
    background: #fff;
}
.message-prompt button {
    border-radius: 15px;
    border-radius: 0 15px 15px 0;
    padding: 10px 20px;
    border: 0;
    background: #0a2764;
    color: #fff;
    cursor: pointer;
}
.message-prompt button svg {
    fill: #fff;
    height: 20px;
    transition: all 250ms;
}
.message-prompt button:hover {
    opacity: 0.9;
}
.message-prompt button:hover svg {
    transform: translateX(3px);
}

.buttons {
    display: flex;
    padding-top: 5px;
}
.buttons a {
    padding: 10px 20px;
    border-radius: 15px;
    text-decoration: none;
    background: #EEE;
    flex: 1;
    text-align: center;
    color: #000;
    font-weight: 500;
    transition: all 1s ease;
}
.buttons a:hover {
    background: #E0E0E0;
}

/** Quick Replies **/
.quick-replies {
    padding: 8px 20px;
    display: flex;
    gap: 10px;
    flex-shrink: 0;
    background: linear-gradient(0deg, rgba(255,255,255,1) 40%, rgba(255,255,255,0) 100%);
    overflow-y: scroll;
}
.quick-replies button {
    color: #1552b2;
    background: #FFF;
    padding: 8px 12px;
    border-radius: 15px;
    border: 1px solid #ecf4ff;
    background: #ecf4ff;
    font-size: 12px;
    flex-shrink: 0;
    transition: all 250ms;
    animation-name: quickReplies;
    animation-duration: 1s;
    opacity: 1;
    animation-timing-function: cubic-bezier(0.075, 0.82, 0.165, 1);
}
.quick-replies button:hover {
    background: #ddeaff;
    cursor: pointer;
    transform: scale(1.05);
    border-color: #1552b2;
}
@keyframes quickReplies {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0px);
    }
}

.chat-header {
    background: #0a2764;
    color: #fff;
    padding: 15px 20px;
    line-height: 1.42;
    font-size: 18px;
    box-shadow: 0 0 10px rgba(0,0,0,.5);
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    align-items: center;
    gap: 20px;
    position: relative;
}
.chat-header .image {
    background: #fff;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    position: relative;
    background-image: url('https://secure.gravatar.com/avatar/7e93de190766edb3f497d1c950c96129?s=96&d=mm&r=g');
    background-size: cover;
}
.chat-header .online-status-bubble {
    background: #6ade40;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    display: block;
    border: 1px solid #fff;
    position: absolute;
    bottom: 0;
    right: 0;
    opacity: 0;
    transition: all 500ms ease;
}
.chat-container.open .chat-header .online-status-bubble {
    opacity: 1;
    animation-name: online-status-bubble, online-status-bubble-pulse;
    animation-duration: 1.5s, 2s;
    animation-delay: 0s, 3s;
    animation-iteration-count: 1, infinite;
    transform-origin: center;
    animation-timing-function: ease;
    box-shadow: 0 0 0 0 rgba(105, 216, 66, .5);
}
@keyframes online-status-bubble {
    from {
        opacity: 0;
        transform: scale(0);
    }
    60% {
        opacity: 0;
        transform: scale(0);
    }
    to {
        opacity: 1;
    }
}
@keyframes online-status-bubble-pulse {
    0% {
        box-shadow: 0 0 0 0 rgba(105, 216, 66, 1);

    }
    100% {
        box-shadow: 0 0 0 5px rgba(105, 216, 66, 0);
    }
}
.chat-header .online-status {
    font-size: 12px !important;
    color: rgba(255,255,255,.5);
}
.chat-buttons {
    display: flex;
    flex-shrink: 0;
    margin-left: auto;
    gap: 6px;
}
.chat-buttons button {
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    cursor: pointer;
    height: 35px;
    width: 35px;
    border: 1px solid rgba(255,255,255,0.15);
    transition: 200ms all ease-in;
    background: unset;
}
.chat-buttons button:hover {
    background: rgba(255,255,255,0.15);
}
.chat-buttons button svg {
    opacity: .8;
    fill: #fff;
    width: 25px;
    transform-origin: center;
    transition: 200ms all ease-in;
}
.chat-buttons button.clear-chat svg {
    height: 18px;
}
.chat-header button.close-chat:hover {
    transform: scale(1.2);
    opacity: 1;
}


.chat-floaty {
    height: 60px;
    width: 60px;
    background: #0a2764;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0,0,0,.2);
    z-index: 2;
    transition: all 1s ease;
	background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 14 14' height='48' width='48'%3E%3Cg%3E%3Ccircle cx='3.5' cy='7' r='0.5' fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round'%3E%3C/circle%3E%3Ccircle cx='6.75' cy='7' r='0.5' fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round'%3E%3C/circle%3E%3Ccircle cx='10' cy='7' r='0.5' fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round'%3E%3C/circle%3E%3Cpath d='M7 .5A6.5 6.5 0 0 0 1.59 10.6L.5 13.5l3.65-.66A6.5 6.5 0 1 0 7 .5Z' fill='none' stroke='%23ffffff' stroke-linecap='round' stroke-linejoin='round'%3E%3C/path%3E%3C/g%3E%3C/svg%3E");
    background-size: 25px;
    background-repeat: no-repeat;
    background-position: center center;
}
.chat-floaty:hover {
    cursor: pointer;
    scale: 1.1;
}
</style>

</head>

<body>

    <div class="log"></div>
    <div class="chat-container" id="chatWidget">
        <div class="chat-box">
            <div class="chat-header">
                <div class="image">
                    <span class="online-status-bubble"></span>
                </div>
                <div>
                    Chat with IrvinGPT now
                    <div class="online-status">(Always) Online</div>
                </div>
                <div class="chat-buttons">
                    <button class="clear-chat" id="chatClearButton">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                          </svg>                          
                        </svg>     
                    </button>
                    <button class="close-chat" id="chatCloseButton">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                        </svg>                          
                    </button>
                </div>
            </div>
            
            <div class="conversation" id="chat-container">
                <!--<div class="message bot">Hi there, how can I help?</div>-->
            </div>

            <div class="quick-replies"></div>
            
            <form class="message-prompt">
                <input type="text" placeholder="Ask me anything..." />
                <button type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                        <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
                    </svg>                      
                </button>
            </form>
        </div>
        <div class="chat-floaty" id="chatBubble"></div>
    </div>

</body>
</html>


<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

// Your web app's Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyAu4agkjhsg-hdPSkM4apik5vs9nCC1md4",
    authDomain: "chatwidget-1b605.firebaseapp.com",
    projectId: "chatwidget-1b605",
    storageBucket: "chatwidget-1b605.appspot.com",
    messagingSenderId: "366974156128",
    appId: "1:366974156128:web:bc8aadb85a4e1827027205",
    databaseURL: "https://chatwidget-1b605-default-rtdb.firebaseio.com"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Firebase Database Service Class
class FirebaseService {
    constructor(db) {
        this.database = db;
    }

    // Function to write data to a specific path
    writeData(path, data) {
        const dbRef = ref(this.database, path);
        set(dbRef, data);
    }

    // Function to read data from a specific path
    async readData(path) {
        const dbRef = ref(this.database, path);
        const snapshot = await get(dbRef);
        return snapshot.val();
    }

    // Function to update data at a specific path
    updateData(path, data) {
        const dbRef = ref(this.database, path);
        update(dbRef, data);
    }

    // Function to remove data at a specific path
    removeData(path) {
        const dbRef = ref(this.database, path);
        remove(dbRef);
    }
}
const firebase = new FirebaseService(db);


/**
 * 
 * Helper Functions 
 * 
 **/
function generateRandomId(length = 10) {
    let result = '';
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const charactersLength = characters.length;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}

// Set a Cookie

function setCookie(name, value, days = 7) { // Default days value
    const date = new Date();
    date.setTime(date.getTime() + (days*24*60*60*1000));
    const expires = "; expires=" + date.toUTCString();
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}

function getCookie(name) {
    const nameEQ = name + "=";
    const cookies = document.cookie.split(';');
    for(let cookie of cookies) {
        while (cookie.charAt(0) === ' ') cookie = cookie.substring(1, cookie.length);
        if (cookie.indexOf(nameEQ) === 0) return cookie.substring(nameEQ.length, cookie.length);
    }
    return null;
}

const chatSessionID = getCookie('chatSessionID');
if (!chatSessionID) {
    var id = generateRandomId(20);
    setCookie('chatSessionID', id, 7);
}


function firebaseStoreMessage(sender, message) {

    const conversationId = chatSessionID; // id of the conversation
    
    // Add a message to the conversation
    var MessageId = generateRandomId(length = 5); // some unique id
    var MessageData = {
        sender: sender,
        content: message,
        timestamp: Date.now() // current timestamp in milliseconds
    };
    
    firebase.writeData(`conversations/${conversationId}/messages/${MessageId}`, MessageData);

}


class ConversationHandler {
    constructor() {
        this.conversation = this.getConversation();
    }

    setCookie(name, value, days = 7) { // Default days value
        const date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        const expires = "; expires=" + date.toUTCString();
        document.cookie = name + "=" + (value || "")  + expires + "; path=/";
    }

    getCookie(name) {
        const nameEQ = name + "=";
        const cookies = document.cookie.split(';');
        for(let cookie of cookies) {
            while (cookie.charAt(0) === ' ') cookie = cookie.substring(1, cookie.length);
            if (cookie.indexOf(nameEQ) === 0) return cookie.substring(nameEQ.length, cookie.length);
        }
        return null;
    }

    clearConversation() {
        this.setCookie('conversation', "", -1);
        this.conversation = [];
    }

    storeConversation() {
        this.setCookie('conversation', JSON.stringify(this.conversation));
    }

    storeMessage(sender, message) {
        this.conversation.push({role: sender, content: message});
        this.storeConversation();
    }

    getConversation() {
        const conversation = this.getCookie('conversation');
        return conversation ? JSON.parse(conversation) : [];
    }
}

class ConversationRenderer {
    constructor(conversationHandler) {
        this.conversationHandler = conversationHandler;
    }

    renderMessage(sender, message) {
        // Create message bubble container
        const chatContainer = document.querySelector('.chat-box .conversation');
        const newMessage = document.createElement('div');
        newMessage.classList.add('message');
        newMessage.innerHTML = message;

        // If it's bot sending message
        if (sender === 'Irvin') {
            newMessage.classList.add('bot');
            // Check if message contains a link
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const url = message.match(urlRegex);
            if (url) {
                const buttonContainer = document.createElement('div');
                buttonContainer.classList.add('buttons');
                newMessage.appendChild(buttonContainer);

                const newButton = document.createElement('a');
                newButton.href = url[0].replace(/[\/\.]$/g, '');
                newButton.innerText = 'Go to link';
                newButton.target = '_blank';
                buttonContainer.appendChild(newButton);
            }
        }

        chatContainer.appendChild(newMessage);
        newMessage.scrollIntoView({ behavior: 'smooth' });
    }

    async renderStoredConversation() {
        console.log('Conversaiont: ' + this.conversationHandler.getConversation());
        let conversation = this.conversationHandler.getConversation();

        // If the conversation exists and it's an array
        if (Array.isArray(conversation) && conversation.length ) {
            // Loop through each message in the conversation
            for (let i = 0; i < conversation.length; i++) {
                // Get the message and sender from the conversation
                let message = conversation[i].content;
                let sender = conversation[i].role;

                // Insert the message into the chat
                this.renderMessage(sender, message);
            }
        } else {
            this.renderMessage('Irvin', 'Hi there, how can I help?');
            this.conversationHandler.storeMessage('Irvin', 'Hi there, how can I help?');
        }
    }

    renderQuickReplies(quickReplies) {
        const repliesContainer = document.querySelector('.quick-replies');

        // Clear previous quick replies
        repliesContainer.innerHTML = '';

        if (quickReplies.length) {
            for (let i = 0; i < quickReplies.length; i++) {
                // Add quick replies
                const quickReply = document.createElement('button');
                quickReply.innerHTML = quickReplies[i];

                repliesContainer.appendChild(quickReply);
            }
        }
    }
}

class AIBot {
    constructor(apiKey, apiURL, botRole, userRole, conversationHandler, conversationRenderer) {
        this.apiKey = apiKey;
        this.apiURL = apiURL;
        this.botRole = botRole;
        this.userRole = userRole;
        this.conversationHandler = conversationHandler;
        this.conversationRenderer = conversationRenderer;

        this.botPersonality = `The following is a chat between ${this.botRole}, a marketing consultant, and a potential lead. ${this.botRole} specializes in helping contractors, such as HVAC, plumbing, grow their business through digital marketing. He is helpful and friendly, answers clearly and concisely. He adopts a consultative approach, asking questions to identify the root issue. His agency, HVAC Marketing Engine, offers only SEO, PPC, and Web Design services. ${this.botRole}'s goal is to get the client to book a call if it sounds like he can help and sends his calendar link through the chat, https://calendly.com/hvacmarketingengine/:\n`;

        this.botLastMessage = '';
    }

    async makeAPICall(prompt, maxTokens) {
        const response = await fetch(this.apiURL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.apiKey}`
            },
            body: JSON.stringify({
                model: "text-davinci-002",
                prompt: prompt,
                max_tokens: maxTokens,
                temperature: 0.6,
                frequency_penalty: 0.5,
                presence_penalty: 0.3,
                stop: [`\n${this.userRole}:`, `\n${this.botRole}:`]
            })
        });
        if (!response.ok) {
            throw new Error(`Request failed with status ${response.status}`);
        }
        return response.json();
    }

    async getResponse(message) {
        try {
            const conversationHistory = this.conversationHandler.getConversation();
            const lastThreeExchanges = conversationHistory.slice(-12);

            let prompt = this.botPersonality;
            for (const message of conversationHistory) {
                prompt += `\n${message.role}: ${message.content}`;
            }
            prompt += `\n${this.botRole}:`;
            console.log('Bot prompt: ' + prompt);

            const data = await this.makeAPICall(prompt, 1000);

            let botResponse = data.choices[0].text.trim();
            
            botResponse = botResponse.replace(new RegExp(`^${this.botRole}:\s*`), ''); // Remove "Irvin:" from the bot response, if present
            
            this.botLastMessage = botResponse;

            return botResponse;
        } catch (error) {
            console.error('Error in getResponse:', error);
            throw error;
        }
    }

    async getQuickReplies() {
        try {
            // Get the latest conversation history
            const conversationHistory = this.conversationHandler.getConversation();
            const lastThreeExchanges = conversationHistory.slice(-3);

            let conversation = this.botPersonality;
            for (const message of lastThreeExchanges) {
                conversation += `\n${message.role}: ${message.content}`;
            }

            const prompt = `${conversation}\n${this.userRole}: \n\nGenerate up to three different ${this.userRole} responses ${this.userRole} can use to respond to ${this.botRole}.\n\nFollow the following guidelines:\n- Do not repeat questions/responses.\n- Only one question.\n- Responses are to be a maximum of 3 words.\n\nReturn in the following format:\n\n1. Response One.\n2. Response Two\n3. Response Three\n\n\nResponses:\n`;

            console.log(prompt);

            const data = await this.makeAPICall(prompt, 550);
            let choices = data.choices[0].text.trim(); // Remove leading and trailing whitespace
            let choicesArray = choices.split('\n'); // Split the string into an array

            // Remove numbers from the start of each string in the array
            choicesArray = choicesArray.map(choice => {
                return choice.replace(/^\d+\.\s*/, '');
            });

            return choicesArray;

        } catch (error) {
            console.error(error);
            throw error;
        }
    }
}


const conversationHandler = new ConversationHandler();
const conversationRenderer = new ConversationRenderer(conversationHandler);
const bot = new AIBot(
    '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', 
    'https://api.openai.com/v1/completions', 
    'Irvin', // Bot role
    'Lead', // User role
    conversationHandler, 
    conversationRenderer
);


/**
 * 
 *  Render conversation on load
 * 
**/
conversationRenderer.renderStoredConversation();

/**
 * 
 * Handle sending message to bot
 * Handle rendering of agent typing/loading chat bubble
 * 
**/
async function sendMessage(message) {
    // Validation before sending message
    if (!message || message.length > 1000) {
        console.error('Invalid message.');
        return;
    }

    // Store user message on cloud
    firebaseStoreMessage('Lead', message);
    
    // Insert typing bubble placeholder
    const chatContainer = document.getElementById('chat-container');
    const typingBubble = document.createElement('div');
    typingBubble.className = 'message bot typing';
    typingBubble.innerHTML = '<span></span><span></span><span></span>';
    chatContainer.appendChild(typingBubble);

    try {
        const botResponse = await bot.getResponse(message);

        
        conversationHandler.storeMessage('Irvin', botResponse);
        firebaseStoreMessage('Irvin', botResponse);

        setTimeout(async () => {
            // Remove the typing bubble
            typingBubble.remove();
            
            // Render bot's response
            conversationRenderer.renderMessage('Irvin', botResponse);

            // Fetch and render quick replies after bot's response
            const quickReplies = await bot.getQuickReplies();
            conversationRenderer.renderQuickReplies(quickReplies);
            
        }, botResponse.length * 0.01 * 100);
    } catch (error) {
        console.error('Error getting bot response:', error);
        typingBubble.remove();
    }
}


/**
 * 
 *  Handle User Submissions
 * 
 **/
const form = document.querySelector('.chat-box .message-prompt');
const inputField = form.querySelector('input');

// Listen for form submission
form.addEventListener('submit', event => {
    event.preventDefault();
    const userMessage = inputField.value;

    // Validation for empty or too long messages
    if (userMessage && userMessage.length <= 1000) {
        conversationRenderer.renderMessage('Lead', userMessage);
        conversationHandler.storeMessage('Lead', userMessage);

        sendMessage(userMessage); 

        inputField.value = '';
    } else {
        console.error('Invalid message.');
    }
});

// Listen for input field focus and load quick replies
inputField.addEventListener('focus', async event => {
    // Use the Bot class's static method to get quick replies
    const quickReplies = await bot.getQuickReplies();

    // Use the ConversationRenderer instance to render the quick replies
    conversationRenderer.renderQuickReplies(quickReplies);
});



/**
 * 
 * Quick Replies
 * 
**/
document.addEventListener('click', event => {
    if (event.target.matches('.quick-replies button')) {
        const buttonMessage = event.target.innerText;

        if (buttonMessage) {
            conversationRenderer.renderMessage('Lead', buttonMessage);
            conversationHandler.storeMessage('Lead', buttonMessage);

            sendMessage(buttonMessage); 
        }
    }
});


const chatBox = document.getElementById('chatWidget');
const chatBubble = document.getElementById('chatBubble');
const chatCloseButton = document.getElementById('chatCloseButton');
const chatClearButton = document.getElementById('chatClearButton');


function clearChat() {
    const chatContainer = document.getElementById('chat-container');
    const messages = chatContainer.getElementsByClassName('message');

    // Convert HTMLCollection to array and iterate in reverse
    for(let i = Array.from(messages).length - 1; i >= 0; i--) {
        chatContainer.removeChild(messages[i]);
    }
}


/**
 * 
 * Clear Conversation
 * 
**/
document.addEventListener('click', event => {
    if (event.target === chatClearButton) {
        // Clear conversation on frontend
        clearChat();
        
        // Clear conversation
        conversationHandler.clearConversation();

        // Load new conversation
        conversationRenderer.renderStoredConversation();
    }

    if (event.target === chatCloseButton || event.target === chatBubble) {
        chatBoxToggle();
    }
});


var chatBoxState = getCookie('chatBoxState');
function chatBoxToggle() {
    if (chatBoxState === 'open') {
        console.log('Open toggle..')
        if(chatBox.classList.contains('open')) {
            chatBox.classList.remove('open');
            chatBoxState = 'close';
            setCookie('chatBoxState', 'close', 30);
        }
    } else {
        chatBox.classList.add('open');
        chatBoxState = 'open';
        setCookie('chatBoxState', 'open', 30);
    }
}

window.onload = function() {
    if (chatBoxState === 'open') {
        chatBox.classList.add('open');
    }
    if (chatBoxState === 'close') {
        chatBox.classList.remove('open');
    }
}
</script>